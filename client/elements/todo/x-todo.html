<link rel="import"
      href="/bower_components/polymer/polymer.html">
<link rel="import" href="/bower_components/iron-a11y-keys/iron-a11y-keys.html">
<link rel="import" href="todo-input.html"/>

<dom-module id="x-todo">
  <link rel="import" type="css" href="x-todo.css">
  <template>

    <firebase-collection
        order-by-child="priority"
        location="https://htasks.firebaseio.com/flags"
        data="{{flags}}" id="flags"></firebase-collection>
    <firebase-collection
        order-by-child="updatedAt"
        limit-to-first="100"
        location="https://htasks.firebaseio.com/todos"
        data="{{todos}}" id="todos"></firebase-collection>
    <todo-flag-select data="{{flags}}" opened="{{flagSelectionDlg.opened}}"
                      todo="{{flagSelectionDlg.todo}}" id="todoFlagSelect"
                      on-flag-selected="_updateTodoAttribute"></todo-flag-select>
    <!--<parse-element id="todos" class_name="Todos" items="{{todos}}"-->
    <!--relations='[{"fieldName": "flag", "className": "flags", "preFetch": true}]'></parse-element>-->
    <!--<parse-element id="flags" class_name="flags" items="{{flags}}"></parse-element>-->
    <paper-material id="newTodo" elevation="2" class="new-todo">
      <iron-a11y-keys id="a11y" target="[[target]]" keys="enter"
                      on-keys-pressed="_addTodo" hidden></iron-a11y-keys>
      <paper-input id="todoTitle" label="Todo Title"
                   value="{{todo.title::input}}" required></paper-input>
      <paper-fab icon="icons:add" on-tap="_addTodo" mini></paper-fab>
    </paper-material>
    <div class="cards">
      <template is="dom-repeat" items="{{todos}}">
        <todo-item item="{{item}}"
                   flags="{{flags}}"
                   on-todo-destroy-item="_destroyTodo"
                   on-todo-update-item="_updateTodo"
                   on-flag-selection="_showFlagSelection"></todo-item>
      </template>
    </div>
  </template>
  <script>
    Polymer({
      is: "x-todo",
      properties: {
        todo: {
          type: Object,
          value: function () {
            return {title: "", finished: false};
          }
        },
        todos: {
          type: Array,
          value: function () {
            return [];
          }
        },
        target: {
          type: Object,
          value: function () {
            return this.$.todoTitle;
          }
        },
        flagSelectionDlg: {
          type: Object,
          value: {"opened": false, "todo": null}
        }
      },
      created: function () { //before localDOM initiates
//        this.todo_relations = [{fieldName: "flag", className: "flags", preFetch: true}];
//        this.flagSelectOpened = true;
      },
      _addTodo: function () {
        if (this.todo.title.trim().length == 0) {
          openToast('title can not be empty');
          return;
        }
        this.todo.updatedAt = this.todo.createdAt = new Date().getTime();
        var ltodo = _.clone(this.todo);
        this.set('todo.title', '');
        this.$.todos.add(ltodo, function (err) {
          if (!err)
            openToast('Task Saved');
        });
      },
      _updateTodo: function (event) {
        console.log(event.detail);
        this.$.todos.query.ref().child(event.detail.__firebaseKey__)
            .update({'updatedAt': new Date().getTime()},
            function (err) {
              if (!err)
                openToast('Task Updated');
            });
      },
      _destroyTodo: function (event) {
        openToast('Task Deleted');
        this.$.todos.remove(event.detail);
      },
      _showFlagSelection: function (event) {
        this.set('flagSelectionDlg.todo', event.detail);
        this.set('flagSelectionDlg.opened', true);
      },
      /*
       event.detail should be an object
       {
       todo: 'todo'
       updations: [ key1, key2 ] //which attributes have been changed
       }
       */
      _updateTodoAttribute: function (event) {
        if (!_.isObject(event.detail.todo)
            || !_.isArray(event.detail.updations))
          return;
        var updates = {'updatedAt': new Date().getTime()};
        _.each(event.detail.updations, function (attr) {
          updates[attr] = event.detail.todo[attr];
        });
        this.$.todos.query.ref().child(event.detail.todo.__firebaseKey__)
            .update(updates, function (err) {
              if (!err)
                openToast('Task Updated');
            });
      }
    });
  </script>
</dom-module>