<link rel="import"
      href="/bower_components/polymer/polymer.html">
<link rel="import" href="/bower_components/iron-a11y-keys/iron-a11y-keys.html">
<link rel="import" href="todo-input.html"/>

<dom-module id="todo-item">
  <link rel="import" type="css" href="todo-item.css">
  <template>
    <paper-material>
      <paper-icon-item on-dblclick="_editAction">
        <paper-checkbox id="tdCheck" checked$="{{localItem.finished}}"
                        on-change="updateFinished" item-icon></paper-checkbox>
        <paper-item-body two-line>
          <div>
            <span id="todo_title" hidden$="{{inEditMode}}">{{localItem.title}}</span>
            <iron-a11y-keys id="a11y" target="[[tdTitleInputTarget]]" keys="enter"
                            on-keys-pressed="_commitAction"></iron-a11y-keys>
            <iron-a11y-keys id="a11y" target="[[tdTitleInputTarget]]" keys="esc"
                            on-keys-pressed="_cancelAction"></iron-a11y-keys>
            <paper-input id="todoTitle" label="Todo Title"
                         hidden$="{{!inEditMode}}" focused="{{focused}}"
                         value="{{_editingValue::input}}" no-label-float>
              <!--<paper-icon-button suffix on-tap="_clearInput"-->
              <!--icon="clear" alt="clear" title="clear">-->
              <!--</paper-icon-button>-->
            </paper-input>
          </div>
          <div secondary>
            Due by: Tomorrow
          </div>
        </paper-item-body>
        <paper-icon-button icon="delete" on-tap="_destroyAction"></paper-icon-button>
        <paper-icon-button icon="more-vert" on-tap="_editTodo"></paper-icon-button>
      </paper-icon-item>
    </paper-material>
  </template>
  <script>
    Polymer({
      is: "todo-item",
      properties: {
        item: {
          type: Object,
          notify: true,
          reflectToAttribute: true,
          value: function () {
            return {title: "", finished: false};
          },
          observer: '_todoChanged'
        },
        tdTitleInputTarget: {
          type: Object,
          value: function () {
            return this.$.todoTitle;
          }
        }
      },
      ready: function () {
        this.inEditMode = false;
        this.focused = false;
      },
      updateFinished: function () { //when Checkbox Clicked
        this.localItem.finished = this.$.tdCheck.checked;
        this.item.set('finished', this.localItem.finished);
        Polymer.Base.toggleClass('finished-todo', this.localItem.finished, this.$.todo_title);
        this.fire('todo-update-item', this.item);
        console.log("updateFinished: " + JSON.stringify(this.item));
      },
      _todoChanged: function (obj) { //when todo object changed
//        console.log("_todoChanged: " + JSON.stringify(obj));
        this.localItem = obj.toJSON();
      },
      _todoCheckChanged: function (checked) { //when todo-finished attribute changed
        Polymer.Base.toggleClass('finished-todo', checked, this.$.todo_title);
        console.log("_todoCheckChanged: " + checked);
      },
      _onBlur: function () {
        this._commitAction();
        this.inEditMode = false;
      },
      _editAction: function () {
        this.inEditMode = true;
        this._editingValue = this.localItem.title;
        // Wait one tick template to stamp.
        this.async(function () {
//          this.querySelector('#todoTitle').focus();
          this.$.todoTitle.focus();
        });
      },
      _commitAction: function () {
        if (this.inEditMode) {
          this.inEditMode = false;
          if (this.localItem.title === this._editingValue.trim())
            return;
          this.set('localItem.title', this._editingValue.trim());
          this.item.set('title', this.localItem.title);
          if (this.localItem.title === '') {
            this._destroyAction();
          } else {
            this.fire('todo-update-item', this.item);
          }
        }
      },
      _editTodo: function () {
        //show popup to edit Task
      },
      _clearInput: function () {
        console.log('clear input');
      },
      _cancelAction: function () {
        this.inEditMode = false;
      },
      _destroyAction: function () {
        this.fire('todo-destroy-item', this.item);
      },
      _focusChanged: function (focused) {
        if (this.inEditMode && !focused)
          this._onBlur();
      },
      observers: [
        '_todoCheckChanged(localItem.finished)',
        '_focusChanged(focused)'
      ]

    })
    ;
  </script>
</dom-module>