<link rel="import"
      href="/bower_components/polymer/polymer.html">
<link rel="import" href="td-input.html"/>

<dom-module id="todo-item">
  <link rel="import" type="css" href="todo-item.css">
  <template>
    <paper-item on-dblclick="_editAction">
      <paper-checkbox id="tdCheck" checked$="{{localItem.finished}}"
                      on-change="updateFinished"></paper-checkbox>
      <span id="todo_title" hidden$="{{inEditMode}}">{{localItem.title}}</span>
      <paper-icon-button icon="delete" hidden="{{inEditMode}}"
                         on-tap="_destroyAction"></paper-icon-button>
      <input is="td-input" hidden$="{{!inEditMode}}" placeholder="Todo Title"
             value="{{_editingValue::input}}"
             on-td-input-commit="_commitAction"
             on-td-input-cancel="_cancelAction"
             on-blur="_onBlur">
      <!--<paper-icon-button suffix onclick="clearInput()" icon="clear" alt="clear" title="clear">-->
      <!--</paper-icon-button>-->
      </input>
    </paper-item>
  </template>
  <script>
    Polymer({
      is: "todo-item",
      properties: {
        item: {
          type: Object,
          notify: true,
          reflectToAttribute: true,
          value: function () {
            return {title: "", finished: false};
          },
          observer: '_todoChanged'
        }
      },
      attach: function () {
        this.localItem = {title: "", finished: false};
      },
      ready: function () {
        this.inEditMode = false;
      },
      updateFinished: function () { //when Checkbox Clicked
        this.localItem.finished = this.$.tdCheck.checked;
        this.item.set('finished', this.localItem.finished);
        Polymer.Base.toggleClass('finished-todo', this.localItem.finished, this.$.todo_title);
        this.fire('todo-update-item', this.item);
        console.log("updateFinished: " + JSON.stringify(this.item));
      },
      _todoChanged: function (obj) { //when todo object changed
        console.log("_todoChanged: " + JSON.stringify(obj));
        this.localItem = obj.toJSON();
      },
      _todoCheckChanged: function (checked) { //when todo-finished attribute changed
        Polymer.Base.toggleClass('finished-todo', checked, this.$.todo_title);
        console.log("_todoCheckChanged: " + checked);
      },
      toggleToEdit: function () {
        this.inEditMode = !this.inEditMode;
        if (this.inEditMode)
          this.$.todo_title.focus();
        console.log("toggleToEdit: " + this.inEditMode);
      },
      _onBlur: function () {
        this._commitAction();
        this.inEditMode = false;
      },
      _editAction: function () {
        this.inEditMode = true;
        this._editingValue = this.localItem.title;
        // Wait one tick template to stamp.
        this.async(function () {
          this.querySelector('#todo_title').focus();
        });
      },
      _commitAction: function () {
        if (this.inEditMode) {
          this.inEditMode = false;
          if (this.localItem.title === this._editingValue.trim())
            return;
          this.set('localItem.title', this._editingValue.trim());
          this.item.set('title', this.localItem.title);
          if (this.localItem.title === '') {
            this._destroyAction();
          } else {
            this.fire('todo-update-item', this.item);
          }
        }
      },
      _cancelAction: function () {
        this.inEditMode = false;
      },
      _destroyAction: function () {
        this.fire('todo-destroy-item', this.item);
      },

      observers: [
        '_todoCheckChanged(localItem.finished)'
      ]

    });
  </script>
</dom-module>